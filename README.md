# Video Similarity Project – 多模態影片相似度比對與侵權偵測系統

## 專案簡介

Video Similarity Project 是一套多模態的影片相似度比對與侵權偵測系統。它整合視覺、音訊、文字三方面的分析技術，以評估兩支影片內容的相似程度。透過深度學習模型與傳統演算法，本系統從畫面、聲音、語意多角度比較影片，協助使用者發現重複內容或潛在的侵權拷貝。 目前系統支援 YouTube、Bilibili 等主流影音平台的影片比對分析，未來可擴充至更多來源。



## 功能特點

- **多模態分析**：同時分析影片的畫面、音訊和字幕內容，提高比對準確度。
  - 視覺分析：提取影片關鍵影格，計算感知哈希 (pHash) 和深度特徵向量，比較畫面內容的相似性。
  - 音頻分析：擷取音訊梅爾頻譜、MFCC 等特徵，以及預訓練模型嵌入向量（OpenL3、PANN），比對音軌的相似性（如背景音樂、講話聲）。。
  - 文本分析：利用 Faster-Whisper 將講話聲音轉寫為文本，再用 SentenceTransformer 算出語意相似度，比較影片主題內容的一致性。

- **影片下載與處理**：內建多平台下載模組，使用 yt-dlp 下載 YouTube/Bilibili 影片。可自訂下載解析度 (預設 720p)，並自動抽取影格進行分析。下載採用快取機制，已下載或處理過的影片會直接重用結果，節省時間。長影片則支援智能採樣，避免處理過載。

- **性能優化**：支援 GPU 加速與多執行緒並行處理。若偵測到 NVIDIA GPU，將自動使用 CUDA 執行模型推理與矩陣運算，以大幅加速轉錄和特徵比對。對於長影片，系統會按片長動態調整採樣頻率並進行分段處理，降低記憶體消耗風險。

- **相似度評估報告**：輸出包含各模態詳細分數以及整體相似度分數的分析報告。當某模態（特別是文本內容）無意義或失敗時，系統會自動降低其權重，並在結果中標註說明，以確保綜合分數的可靠性和可解讀性。




## 技術架構

專案採用前後端分離的模組化架構，主要組成部分如下：

- **前端 (frontend)**  
  基於 Vue3 + Vite 開發的單頁應用 (SPA)。用戶在瀏覽器輸入影片 URL 並發起比對請求，透過 AJAX 與後端 API 互動，並使用 Server-Sent Events (SSE) 即時接收進度更新。  
  介面包含輸入控制面板、任務佇列列表、結果顯示區三部分，支援響應式更新。

- **後端 API (backend)**  
  使用 FastAPI 架構的 RESTful API 服務：  
  - `/api/compare`：接收比對請求，返回任務 ID 並啟動比對流程。  
  - `/api/events`：提供 SSE 端點，持續推送進度與結果。  
  - `/api/status`：查詢本地快取進度，用於顯示已完成的部分處理結果。  
  採用 `sse-starlette` 實現 SSE 推送機制。

- **比對流程 (cli/main.py)**  
  後端接收請求後，啟動 CLI 子程序執行比對任務，協調多個核心模組完成影片下載、音訊提取、轉錄與多模態相似度計算，最後輸出 JSON 結果。

- **影像處理 (core/image_processor.py)**  
  提取影像特徵並計算相似度，包括感知哈希與深度特徵嵌入，採用雙階段法比較影片畫面相似度。

- **音訊處理 (core/audio_processor.py)**  
  將影片轉為 WAV 音訊，提取 MFCC、色譜、節奏等傳統特徵，以及 OpenL3、PANN 深度音訊特徵，計算音訊相似度分數。

- **文字處理 (core/text_processor.py)**  
  使用 Faster-Whisper 轉錄音訊為中英文文字，再用 SentenceTransformer 計算字幕語意相似度。

- **相似度融合 (core/similarity.py)**  
  將音訊、影像、文字三種相似度加權融合為綜合分數，權重可配置，並會在文字資訊不足時動態調整比例。

- **日誌與依賴管理 (utils/)**  
  - `logger.py`：設定全域日誌格式，統一控制台與檔案輸出。  
  - `dependencies.py`：啟動時檢查 ffmpeg、yt-dlp、CUDA 等關鍵環境。  
  - 其他工具如 `downloader.py` (影片下載與安全檔名生成)、`video_utils.py` (影片抽幀與資訊獲取)。



## 專案結構

```
video_similarity_project/
├── frontend/              # 前端 Vue3 專案
│   ├── src/
│   │   ├── components/    # 拆分後的子元件 (ControlPanel.vue, TaskQueue.vue, ResultsList.vue 等)
│   │   ├── App.vue        # 前端主元件，掛載子元件並維護全域狀態
│   │   └── main.js        # Vue 應用入口
│   └── ...               (設定檔與靜態資源等)
├── backend/
│   ├── main.py            # FastAPI 應用啟動與路由掛載
│   └── api/
│       ├── compare_api.py     # API 路由定義 (比對啟動、事件、狀態、取消)
│       └── compare_service.py # 比對執行服務 (子進程管理、日誌解析、事件推送)
├── core/                  # 後端核心算法模組
│   ├── image_processor.py    
│   ├── audio_processor.py
│   ├── text_processor.py
│   ├── similarity.py
│   └── ... 
├── utils/                 # 工具模組
│   ├── downloader.py          # 影片下載工具 (使用 yt-dlp)
│   ├── video_utils.py         # 視頻資訊獲取與影格處理
│   ├── logger.py              # 日誌設定
│   └── dependencies.py        # 執行環境/依賴檢查
├── cli/
│   └── main.py            # 命令列執行主程式 (多線程協調各模組完成比對流程)
├── downloads/             # 影片下載及中間檔案輸出目錄 (程式執行後生成)
│   ├── audio/                 # 提取的音訊檔 (.wav)
│   ├── frames/                # 抽取的影格圖像
│   └── (各影片 *.mp4, *_transcript.txt/.json 等)
├── feature_cache/         # 特徵快取資料夾 (如音訊特徵向量 .npz)
├── requirements.txt       # Python 相依套件清單 
├── install_dependencies.py    # 一鍵安裝腳本 
├── start_project.py           # 開發用啟動腳本 (同時啟動後端與前端開發伺服器)
├── README.md               # 說明文件 (本檔案)
├── .gitignore
└── www.youtube.com_cookies.txt  # 下載器 cookies（如有需求）
```



## 安裝與環境需求

### 環境要求：
- **作業系統**：Windows
- **Node.js**：建議安裝最新版本（前端開發用）
- **Python**：3.8 以上版本
- **硬體加速（選擇性）**：
  - 若有 NVIDIA 顯卡，請安裝對應的 CUDA Toolkit（建議 11 以上）與驅動，以啟用 GPU 加速
  - 無 GPU 時可在 CPU 上運行，但速度會較慢
- **必要外部工具**（需已加入系統 `PATH`）：
  - FFmpeg – 視訊/音訊處理，抽取音訊與影格
  - yt-dlp – 第三方影片下載器
- **提示**：若未安裝上述工具，可執行 `install_dependencies.py` 腳本

### 安裝步驟：

1. 取得程式碼：克隆此專案倉庫至本地
   ```bash
   git clone https://github.com/terrylu930119/video_similarity_project.git
   cd video_similarity_project
   ```

2. 執行 `install_dependencies.py` 腳本，將會自動確認目前環境與安裝python、前端套件
   ```bash
   python install_dependencies.py
   ```

注意：首次執行比對程式時，程式會自動下載所需的機器學習模型（Whisper 等，約數百MB至1GB），請確保網路通暢。




## 使用方式

安裝完成後，可通過命令列介面使用本工具：

### 基本用法：
在虛擬環境的終端執行 `start_project.py`，將會自動啟動前端與路由終端，並開啟瀏覽器前往使用畫面
```bash
python start_project.py
```
### IDE用法：
在虛擬環境的終端執行 `cli/main.py` 並提供參考影片和一個或多個要比對的影片連結：
```bash
python -m cli.main --ref <參考影片網址> --comp <待比對影片網址1> <待比對影片網址2> ... [選項]
```

### CLI用法：
在虛擬環境的終端執行 `cli/main.py` 並提供參考影片和一個或多個要比對的影片連結：
```bash
python -m cli.main --ref <參考影片網址> --comp <待比對影片網址1> <待比對影片網址2> ... [選項]
```

#### 必填參數：
- `--ref`：參考影片的網址 (URL)
- `--comp`：一個或多個欲比對影片的網址，可以提供多個

#### 選用參數：
- `--output`：指定下載及處理的輸出目錄，預設為 downloads
- `--cache`：指定特徵快取目錄，預設為 feature_cache
- `--interval`：幀提取的時間間隔（秒），可設定為'auto'
- `--keep`：加入此參數則保留中間下載的影音及提取的特徵文件（不自動刪除）

#### 結果解讀：
比對完成後，終端輸出表格包含每個待比對影片相對於參考影片的相似度分數，例如：

```
=== 相似度比對結果 ===
參考影片: https://youtu.be/abc123...

比對結果:
------------------------------------------------------------------------------------------------------------
影片連結                                                    音訊相似度   畫面相似度   內容相似度   綜合相似度
------------------------------------------------------------------------------------------------------------
https://youtu.be/def456...                                   0.8457       0.9123       0.0000*      0.8804
https://www.bilibili.com/video/BVXXXXX...                    0.6578       0.7012       0.7345       0.6939
------------------------------------------------------------------------------------------------------------
註: * 表示該影片的文本內容被判定為無意義，其文本相似度權重已被重新分配到音訊和畫面相似度
```



### 相似度分數解讀指引（音頻 × 畫面 × 文本）

本系統使用多模態比對方式，針對「音頻」、「畫面」、「轉錄文本」三個維度進行相似度評估。以下為各項分數的解讀說明，分數範圍皆為 0.0 ~ 1.0，分數越高代表內容越相似。

---

**音頻相似度解讀表（Perceptual Audio Similarity）**

| 分數範圍      | 判定標籤   | 解釋說明                                               |
|:-------------:|:---------:|:------------------------------------------------------|
| ≥ 0.88        | 極高相似   | 聲音結構、音色、節奏與語義一致，極可能為同源影片或轉碼版本 |
| 0.75 – 0.88   |  高相似    | 多數特徵重合，可能為不同來源、混音版、現場翻唱等變體      |
| 0.60 – 0.75   | 中度相似   | 屬於相同曲風或相似片段重疊，但非同一原始內容             |
| 0.40 – 0.60   | 低度相似   | 僅有少數特徵吻合，可視為不同來源                        |
| < 0.40        | 無明顯關聯 | 聲音特徵差異明顯，判定為完全不同音源                     |

---

**畫面相似度解讀表（Video Frame Similarity）**

| 分數範圍      | 判定標籤   | 解釋說明                                               |
|:-------------:|:---------:|:------------------------------------------------------|
| ≥ 0.90        | 極高相似   | 畫面幾乎一致，疑似轉載或語音更換後重製                   |
| 0.82 – 0.90   | 高相似     | 多數畫面重合，僅有輕微剪輯或過渡效果                     |
| 0.70 – 0.82   | 中高相似   | 主體一致性高，可能為剪輯版、語言替換或平台版本差異        |
| 0.55 – 0.70   | 中度相似   | 局部共用元素，含片頭、插圖或共用素材                     |
| 0.35 – 0.55   | 低度相似   | 僅小比例畫面一致，整體風格不同                          |
| < 0.35        | 無明顯關聯 | 畫面、節奏與色彩特徵皆不同，無實質重合                   |

---

**文本相似度解讀表（Transcript Semantic Similarity）**

| 分數範圍      | 判定標籤   | 解釋說明                                               |
|:-------------:|:---------:|:------------------------------------------------------|
| ≥ 0.85        | 高度相似   | 內容幾乎相同，疑似翻譯、抄襲或改寫                       |
| 0.70 – 0.85   | 中高相似   | 主題一致，語句結構不同但語意接近                         |
| 0.50 – 0.70   | 中度相似   | 有共用資料來源或敘述主題相同                             |
| 0.30 – 0.50   | 低度相似   | 僅有少量概念重合，非同一內容改寫                         |
| < 0.30        | 無明顯關聯 | 幾乎無語意重疊，可視為完全不同文本                       |

---

> **註**：分數僅供參考，實際判斷仍需結合影片內容與人工審查。



## 資料夾與模組說明

- **downloads/**：預設的影片下載及處理輸出目錄。執行比對時，下載的原始影片文件、擷取的幀圖片、轉錄的字幕文字等都儲存在此資料夾下（按照影片ID區分子目錄）。如果不加 --keep 參數，程式在完成後會自動清理此資料夾。

- **feature_cache/**：預設的音訊特徵快取目錄。音頻分析模組會將提取的特徵向量快取到此，例如 .npy 或 .pkl 檔案，以加速重複影片的比對。同樣地，若未指定 --keep，程式結束時會刪除此目錄釋放空間。

- **core/**：多模態分析核心代碼：
  - audio_processor.py：音訊處理模組，音訊處理與相似度計算（MFCC、Chroma、Onset、Tempo、PANN、OpenL3 等特徵）。
  - image_processor.py：圖像處理模組，影像特徵處理與兩階段相似度計算（pHash + SSIM 快速比對、MobileNetV3 深度特徵）。
  - text_processor.py：文本處理模組，音訊轉錄（Faster-Whisper）與文本相似度計算（Sentence-Transformers）。
  - similarity.py：相似度融合模組，音訊、影像、文本三模態加權融合為總分。

- **utils/**：共用工具模組 ：
  - downloader.py：影片下載與命名工具，使用 yt-dlp 下載影片並生成安全檔名。
  - video_utils.py：視頻相關工具，抽幀、影片資訊取得、格式驗證等。
  - audio_cleaner.py：音訊預處理工具，音訊預處理（去靜音、降噪）。
  - gpu_utils.py：GPU 記憶體管理工具，釋放顯存快取。
  - logger.py：日誌模組，統一日誌格式輸出（CLI 與 SSE 同時鏡像輸出）。

- **backend/**：後端 API 與服務邏輯：
  - api/compare_api.py：定義比對相關 API 路由（啟動、進度 SSE、取消任務、狀態查詢）。
  - api/compare_service.py：封裝比對任務管理、子進程執行、日誌解析、進度推送等邏輯。
  - main.py：FastAPI 應用入口。

- **frontend/src**：Vue3 前端程式碼：
  - components/：拆分後的子元件（控制面板、任務佇列、結果列表等）。
  - App.vue：前端主元件，維護全域狀態與 SSE 事件處理。
  - main.js：Vue 應用入口

- **panns_inference/**：內含預訓練環境音分類模型（PANN: Pretrained Audio Neural Networks）的相關程式碼。本專案使用其中的 Cnn14 模型來提取音訊的環境聲音特徵向量，用於輔助音訊相似度計算。該資料夾下包括模型定義、權重下載/載入以及推理所需的工具程式。

### 其他文件：
- requirements.txt：Python 依賴套件清單（FastAPI、PyTorch、yt-dlp、faster-whisper 等）。
- install_dependencies.py：一鍵安裝腳本，涵蓋後端、前端依賴與外部工具安裝。
- start_project.py：Windows 一鍵啟動前後端開發伺服器。
- README.md：專案說明文件（本檔案）。
- LICENSE：授權協議（預設 MIT）。


## 授權條款 

本專案採用 **雙授權模式**：

- **非商業用途** → 遵循 [CC BY-NC 4.0](https://creativecommons.org/licenses/by-nc/4.0/) 授權，免費使用，但禁止商業用途。
- **商業用途** → 必須取得作者書面授權，並依協議支付分潤（預設為淨收入 20%，可依協議調整）。

如需商業授權，請聯繫：lu930119@gmail.com
